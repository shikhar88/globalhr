tinymce.PluginManager.add('watermark_filemanager', function(editor) {
    function openmanager() {
        var win, data, dom = editor.dom,
            imgElm = editor.selection.getNode();
        var width, height, imageListCtrl;
        var watermarks=editor.dom.select("[data-type='watermark']");
        var append='';
        if(watermarks.length){
        //url=watermarks[0].getAttrib('scr');
        append='&watermark='+(editor.dom.getAttrib(watermarks[0],'data-file',''));

        }

        win = editor.windowManager.open({

            title: 'Insert watermark',

            file: tinyMCE.baseURL + '/plugins/watermark_filemanager/dialog.php?popup=1&editor=' + editor.id + '&lang=' + tinymce.settings.language + '&subfolder=' + tinymce.settings.subfolder+append,
            filetype: 'all',
            classes: 'filemanager',
            width: 900,
            height: 600,
            inline: 1
        })
    }
    editor.addButton('watermark_filemanager', {
        icon: 'icon-watermark',
        tooltip: 'Insert watermark',
        onclick: openmanager,
        stateSelector: 'img:not([data-mce-object])'
    });
    editor.addMenuItem('watermark_filemanager', {
        icon: 'icon-watermark',
        text: 'Insert watermark',
        onclick: openmanager,
        context: 'insert',
        prependToContext: true
    })
});